function addToGoogleCalendar(dayId, activityId) {
    const day = itineraryData.find(d => d.id === dayId);
    const activity = day.activities.find(a => a.id === activityId);

    // Converti la data italiana in oggetto Date con fuso orario locale
    const [dayNumber, monthName, year] = day.date.split(' ');
    const months = {
        'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3,
        'maggio': 4, 'giugno': 5, 'luglio': 6, 'agosto': 7,
        'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
    };

    // Funzione per convertire gli orari
    const parseTime = (timeStr) => {
        if (!timeStr) return { h: 0, m: 0 };
        const cleaned = timeStr.replace(/\./g, ':').replace(/\D/g, '');
        return {
            h: parseInt(cleaned.slice(0, 2)) || 0,
            m: parseInt(cleaned.slice(2, 4)) || 0
        };
    };

    // Gestione intervalli
    const [startStr, endStr] = activity.time.split(/[-â€“]/).map(s => parseTime(s.trim()));
    let startDate = new Date(year, months[monthName.toLowerCase()], dayNumber);
    let endDate = new Date(year, months[monthName.toLowerCase()], dayNumber);

    // Imposta orari locali corretti
    startDate.setHours(startStr.h, startStr.m);
    
    if (endStr) {
        endDate.setHours(endStr.h, endStr.m);
    } else {
        endDate = new Date(startDate.getTime() + (15 * 60 * 1000)); // +15 min
    }

    // Formattazione ISO con offset fuso orario
    const formatForGoogle = (date) => {
        const pad = n => n.toString().padStart(2, '0');
        const tzOffset = -date.getTimezoneOffset();
        const diff = tzOffset >= 0 ? '+' : '-';
        const padH = Math.floor(Math.abs(tzOffset) / 60).toString().padStart(2, '0');
        const padM = (Math.abs(tzOffset) % 60).toString().padStart(2, '0');
        
        return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}` +
               `T${pad(date.getHours())}${pad(date.getMinutes())}00` +
               `${diff}${padH}${padM}`;
    };

    // Costruisci URL finale
    const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: activity.title,
        dates: `${formatForGoogle(startDate)}/${formatForGoogle(endDate)}`,
        details: `${activity.description || ''}\nNote: ${activity.notes || ''}`.trim(),
        ctz: Intl.DateTimeFormat().resolvedOptions().timeZone
    });

    window.open(`https://calendar.google.com/calendar/render?${params}`, '_blank');
}