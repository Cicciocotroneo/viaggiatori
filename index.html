<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1976d2">
    <title>Pianificazione Viaggio</title>
    <link rel="manifest" href="#manifest" crossorigin="use-credentials">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pianifica Viaggio">
    <style>
        :root {
            --primary: #1976d2;
            --primary-dark: #1565c0;
            --secondary: #ff4081;
            --light-gray: #f5f5f5;
            --gray: #e0e0e0;
            --dark-gray: #757575;
            --white: #ffffff;
            --black: #212121;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-gray);
            color: var(--black);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .logo h1[contenteditable="true"]:focus {
            outline: 2px dashed var(--secondary);
            padding: 0.2rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1rem;
        }
        
        nav a {
            color: var(--white);
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav a:hover {
            background-color: var(--primary-dark);
        }
        
        main {
            margin: 2rem 0;
        }
        
        .section {
            margin-bottom: 2rem;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray);
        }
        
        .section-title {
            font-size: 1.25rem;
            color: var(--primary);
        }
        
        .day {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed var(--gray);
        }
        
        .day:last-child {
            border-bottom: none;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary);
            color: var(--white);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .day-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .day-date {
            font-size: 0.9rem;
        }
        
        .activity {
            background-color: var(--light-gray);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .activity:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .activity-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .activity-time {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }
        
        .activity-description {
            margin-bottom: 1rem;
            white-space: pre-line; /* Preserva gli spazi e le interruzioni di riga */
        }
        
        .edit-activity {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .activity-notes {
            border-top: 1px solid var(--gray);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            font-style: italic;
            white-space: pre-line; /* Preserva gli spazi e le interruzioni di riga */
        }
        
        .tips-list {
            padding-left: 1.5rem;
        }
        
        .tips-list li {
            margin-bottom: 0.5rem;
        }
        
        .emergency-card {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .emergency-item {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .emergency-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .emergency-number {
            font-size: 1.25rem;
            color: var(--error);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--white);
        }
        
        .btn-secondary:hover {
            background-color: #e91e63;
        }
        
        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }
        
        .btn-success:hover {
            background-color: #388e3c;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--white);
        }
        
        .btn-warning:hover {
            background-color: #f57c00;
        }
        
        .btn-error {
            background-color: var(--error);
            color: var(--white);
        }
        
        .btn-error:hover {
            background-color: #d32f2f;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .checkbox-label input {
            width: 18px;
            height: 18px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray);
        }
        
        .modal-title {
            font-size: 1.25rem;
            color: var(--primary);
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--dark-gray);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .floating-action {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .fab-primary {
            background-color: var(--primary);
            color: var(--white);
        }
        
        .fab-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .fab-secondary {
            background-color: var(--secondary);
            color: var(--white);
        }
        
        .fab-secondary:hover {
            background-color: #e91e63;
        }
        
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        #notification {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
            z-index: 900;
        }
        
        .add-item-btn {
            width: 100%;
            margin-top: 1rem;
        }
        
        .tip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .tip-item button {
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
        }
        
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .section {
                padding: 1rem;
            }
            
            .day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .activity-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .fab {
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">
                <h1 contenteditable="true" id="main-title">Il Mio Viaggio</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="#programma">Programma</a></li>
                    <li><a href="#consigli">Consigli</a></li>
                    <li><a href="#numeri-utili">Numeri Utili</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <main class="container">
        <section id="programma" class="section">
            <div class="section-header">
                <h2 class="section-title">Programma del Viaggio</h2>
                <div>
                    <button class="btn btn-primary" onclick="exportItinerary()">
                        <span>Esporta Programma</span>
                    </button>
                    <button class="btn btn-error" onclick="clearAllData()" style="margin-left: 10px;">
                        <span>Cancella Tutti i Dati</span>
                    </button>
<button class="btn btn-primary" onclick="exportDataToJson()">
    <span>Esporta JSON</span>
</button>
<button class="btn btn-primary" onclick="importDataFromJson()" style="margin-left: 10px;">
    <span>Importa JSON</span>
</button>
                </div>
            </div>
            
            <div id="days-container">
                <!-- Il contenuto verr√† popolato con JavaScript -->
            </div>
        </section>
        
        <section id="consigli" class="section">
            <div class="section-header">
                <h2 class="section-title">Consigli Utili</h2>
            </div>
            
            <div class="tips-container">
                <h3>Per il viaggio:</h3>
                <ul class="tips-list" id="tips-general">
                    <!-- Il contenuto verr√† popolato con JavaScript -->
                </ul>
                <button class="btn btn-secondary add-item-btn" onclick="showAddTipModal('general')">Aggiungi Consiglio</button>
                
                <h3>Per gli spostamenti:</h3>
                <ul class="tips-list" id="tips-transport">
                    <!-- Il contenuto verr√† popolato con JavaScript -->
                </ul>
                <button class="btn btn-secondary add-item-btn" onclick="showAddTipModal('transport')">Aggiungi Consiglio</button>
                
                <h3>Per le attrazioni:</h3>
                <ul class="tips-list" id="tips-attractions">
                    <!-- Il contenuto verr√† popolato con JavaScript -->
                </ul>
                <button class="btn btn-secondary add-item-btn" onclick="showAddTipModal('attractions')">Aggiungi Consiglio</button>
            </div>
        </section>
        
        <section id="numeri-utili" class="section">
            <div class="section-header">
                <h2 class="section-title">Numeri Utili</h2>
                <button class="btn btn-secondary" onclick="showAddEmergencyModal()">Aggiungi Contatto</button>
            </div>
            
            <div class="emergency-card" id="emergency-container">
                <!-- Il contenuto verr√† popolato con JavaScript -->
            </div>
        </section>
    </main>
    
    <div class="floating-action">
        <button class="fab fab-secondary" onclick="installPWA()" id="install-button" style="display: none;">üì±</button>
        <button class="fab fab-primary" onclick="showAddDayModal()" title="Aggiungi giornata">+</button>
    </div>
    
    <div id="notification"></div>
    
    <!-- Modal per modificare attivit√† -->
    <div id="edit-activity-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifica Attivit√†</h3>
                <span class="close-modal" onclick="closeModal('edit-activity-modal')">&times;</span>
            </div>
            <form id="edit-activity-form">
                <input type="hidden" id="edit-day-id">
                <input type="hidden" id="edit-activity-id">
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-title">Titolo</label>
                    <input type="text" class="form-control" id="edit-activity-title" required placeholder="Inserisci il titolo dell'attivit√†">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-time">Orario</label>
                    <input type="text" class="form-control" id="edit-activity-time" placeholder="es. 09:00 - 12:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-description">Descrizione</label>
                    <textarea class="form-control" id="edit-activity-description" rows="4" placeholder="Descrivi cosa farai durante questa attivit√†..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-notes">Note Personali</label>
                    <textarea class="form-control" id="edit-activity-notes" rows="3" placeholder="Aggiungi le tue note personali qui..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-error" onclick="deleteActivity()">Elimina</button>
                    <button type="button" class="btn btn-primary" onclick="saveActivity()">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere giorno -->
    <div id="add-day-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Giorno</h3>
                <span class="close-modal" onclick="closeModal('add-day-modal')">&times;</span>
            </div>
            <form id="add-day-form">
                <div class="form-group">
                    <label class="form-label" for="add-day-title">Titolo</label>
                    <input type="text" class="form-control" id="add-day-title" required placeholder="es. Primo giorno - Arrivo a destinazione">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-day-date">Data</label>
                    <input type="date" class="form-control" id="add-day-date" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="addDay()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere attivit√† -->
    <div id="add-activity-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Attivit√†</h3>
                <span class="close-modal" onclick="closeModal('add-activity-modal')">&times;</span>
            </div>
            <form id="add-activity-form">
                <input type="hidden" id="add-activity-day-id">
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-title">Titolo</label>
                    <input type="text" class="form-control" id="add-activity-title" required placeholder="es. Visita museo, Pranzo, Escursione...">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-time">Orario</label>
                    <input type="text" class="form-control" id="add-activity-time" placeholder="es. 09:00 - 12:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-description">Descrizione</label>
                    <textarea class="form-control" id="add-activity-description" rows="4" placeholder="Descrivi cosa farai durante questa attivit√†..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-notes">Note Personali</label>
                    <textarea class="form-control" id="add-activity-notes" rows="3" placeholder="Aggiungi le tue note personali qui..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="saveNewActivity()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere consiglio -->
    <div id="add-tip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Consiglio</h3>
                <span class="close-modal" onclick="closeModal('add-tip-modal')">&times;</span>
            </div>
            <form id="add-tip-form">
                <input type="hidden" id="add-tip-category">
                
                <div class="form-group">
                    <label class="form-label" for="add-tip-text">Consiglio</label>
                    <textarea class="form-control" id="add-tip-text" rows="3" required placeholder="Inserisci un consiglio utile..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="addTip()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per modificare consiglio -->
    <div id="edit-tip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifica Consiglio</h3>
                <span class="close-modal" onclick="closeModal('edit-tip-modal')">&times;</span>
            </div>
            <form id="edit-tip-form">
                <input type="hidden" id="edit-tip-category">
                <input type="hidden" id="edit-tip-id">
                
                <div class="form-group">
                    <label class="form-label" for="edit-tip-text">Consiglio</label>
                    <textarea class="form-control" id="edit-tip-text" rows="3" required></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-error" onclick="deleteTip()">Elimina</button>
                    <button type="button" class="btn btn-primary" onclick="saveTip()">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere contatto di emergenza -->
    <div id="add-emergency-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Contatto</h3>
                <span class="close-modal" onclick="closeModal('add-emergency-modal')">&times;</span>
            </div>
            <form id="add-emergency-form">
                <div class="form-group">
                    <label class="form-label" for="add-emergency-name">Nome</label>
                    <input type="text" class="form-control" id="add-emergency-name" required placeholder="es. Hotel, Emergenze, Ambasciata...">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-emergency-number">Numero</label>
                    <input type="text" class="form-control" id="add-emergency-number" required placeholder="es. +39 123 4567890">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="addEmergency()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per modificare contatto di emergenza -->
    <div id="edit-emergency-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifica Contatto</h3>
                <span class="close-modal" onclick="closeModal('edit-emergency-modal')">&times;</span>
            </div>
            <form id="edit-emergency-form">
                <input type="hidden" id="edit-emergency-id">
                
                <div class="form-group">
                    <label class="form-label" for="edit-emergency-name">Nome</label>
                    <input type="text" class="form-control" id="edit-emergency-name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-emergency-number">Numero</label>
                    <input type="text" class="form-control" id="edit-emergency-number" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-error" onclick="deleteEmergency()">Elimina</button>
                    <button type="button" class="btn btn-primary" onclick="saveEmergency()">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
       
        // Dati dei consigli con placeholder
        let tipsGeneralData = [
            "Esempio: Verifica i documenti necessari per il viaggio",
            "Esempio: Controlla le previsioni meteo prima della partenza",
            "Esempio: Porta con te medicinali di base"
        ];

        let tipsTransportData = [
            "Esempio: Verifica gli orari dei mezzi pubblici in anticipo",
            "Esempio: Considera l'acquisto di biglietti o pass per pi√π giorni",
            "Esempio: Scarica l'app per la mobilit√† locale"
        ];

        let tipsAttractionsData = [
            "Esempio: Prenota le attrazioni principali in anticipo",
            "Esempio: Verifica gli orari di apertura e chiusura",
            "Esempio: Cerca sconti o offerte per gruppi/famiglie"
        ];

// Dati dei numeri utili con placeholder
        let emergencyData = [
            {
                id: 1,
                name: "Emergenze",
                number: "112"
            },
            {
                id: 2,
                name: "Esempio: Hotel",
                number: "+00 123 456789"
            },
            {
                id: 3,
                name: "Esempio: Contatto locale",
                number: "+00 987 654321"
            }
        ];

        // Funzioni per la gestione del localStorage
        function saveToLocalStorage() {
            const mainTitle = document.getElementById('main-title').innerText;
            localStorage.setItem('mainTitle', mainTitle);
            localStorage.setItem('itineraryData', JSON.stringify(itineraryData));
            localStorage.setItem('tipsGeneralData', JSON.stringify(tipsGeneralData));
            localStorage.setItem('tipsTransportData', JSON.stringify(tipsTransportData));
            localStorage.setItem('tipsAttractionsData', JSON.stringify(tipsAttractionsData));
            localStorage.setItem('emergencyData', JSON.stringify(emergencyData));
            showNotification('Dati salvati');
        }

        function loadFromLocalStorage() {
            const savedTitle = localStorage.getItem('mainTitle');
            const savedItinerary = localStorage.getItem('itineraryData');
            const savedTipsGeneral = localStorage.getItem('tipsGeneralData');
            const savedTipsTransport = localStorage.getItem('tipsTransportData');
            const savedTipsAttractions = localStorage.getItem('tipsAttractionsData');
            const savedEmergency = localStorage.getItem('emergencyData');
            
            if (savedTitle) {
                document.getElementById('main-title').innerText = savedTitle;
            }
            
            if (savedItinerary) {
                itineraryData = JSON.parse(savedItinerary);
            }
            
            if (savedTipsGeneral) {
                tipsGeneralData = JSON.parse(savedTipsGeneral);
            }
            
            if (savedTipsTransport) {
                tipsTransportData = JSON.parse(savedTipsTransport);
            }
            
            if (savedTipsAttractions) {
                tipsAttractionsData = JSON.parse(savedTipsAttractions);
            }
            
            if (savedEmergency) {
                emergencyData = JSON.parse(savedEmergency);
            }
            
            renderAll();
            showNotification('Dati caricati');
        }
        
        function renderAll() {
            renderDays();
            renderTips();
            renderEmergencyNumbers();
        }

        // Funzioni di rendering
        function renderDays() {
            const daysContainer = document.getElementById('days-container');
            daysContainer.innerHTML = '';

            itineraryData.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.classList.add('day');
                dayElement.id = `day-${day.id}`;

                const dayHeader = document.createElement('div');
                dayHeader.classList.add('day-header');
                dayHeader.innerHTML = `
                    <div class="day-title">${day.title}</div>
                    <div class="day-date">${day.date}</div>
                `;

                const activitiesContainer = document.createElement('div');
                activitiesContainer.classList.add('activities-container');

                day.activities.forEach(activity => {
                    const activityElement = document.createElement('div');
                    activityElement.classList.add('activity');
                    if (activity.completed) activityElement.classList.add('completed');

                    // Funzione per convertire i ritorni a capo in tag HTML <br> e permettere l'uso di link HTML
                    function processText(text) {
                        // Permette l'uso di tag HTML ma sanitizza per sicurezza
                        // Converte i ritorni a capo in <br> solo se non sono gi√† in un tag HTML
                        return text.replace(/\n/g, '<br>');
                    }
                    
                    const activityContent = `
                        <div class="activity-header">
                            <div class="activity-title">
                                <label class="checkbox-label">
                                    <input type="checkbox" onchange="toggleActivityCompletion(${day.id}, ${activity.id})" ${activity.completed ? 'checked' : ''}>
                                    <span>${activity.title}</span>
                                </label>
                            </div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                        <div class="activity-description">${processText(activity.description)}</div>
                        ${activity.notes ? `<div class="activity-notes">${processText(activity.notes)}</div>` : ''}
                        <div class="edit-activity">
                            <button class="btn btn-primary" onclick="showEditActivityModal(${day.id}, ${activity.id})">Modifica</button>
                        </div>
                    `;

                    activityElement.innerHTML = activityContent;
                    activitiesContainer.appendChild(activityElement);
                });

                const addActivityButton = document.createElement('button');
                addActivityButton.classList.add('btn', 'btn-secondary');
                addActivityButton.textContent = 'Aggiungi Attivit√†';
                addActivityButton.onclick = () => showAddActivityModal(day.id);

                dayElement.appendChild(dayHeader);
                dayElement.appendChild(activitiesContainer);
                dayElement.appendChild(addActivityButton);

                daysContainer.appendChild(dayElement);
            });
            
            // Aggiunge un pulsante per aggiungere un giorno se non ci sono giorni
            if (itineraryData.length === 0) {
                const emptyStateElement = document.createElement('div');
                emptyStateElement.classList.add('empty-state');
                emptyStateElement.innerHTML = `
                    <p>Non hai ancora aggiunto giorni al tuo programma.</p>
                    <button class="btn btn-primary" onclick="showAddDayModal()">Aggiungi il primo giorno</button>
                `;
                daysContainer.appendChild(emptyStateElement);
            }
        }

        function renderTips() {
            renderTipCategory('tips-general', tipsGeneralData);
            renderTipCategory('tips-transport', tipsTransportData);
            renderTipCategory('tips-attractions', tipsAttractionsData);
        }
        
        function renderTipCategory(containerId, tipsData) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            tipsData.forEach((tip, index) => {
                const tipElement = document.createElement('li');
                tipElement.classList.add('tip-item');
                tipElement.innerHTML = `
                    <span>${tip}</span>
                    <button class="btn btn-primary" onclick="showEditTipModal('${containerId.replace('tips-', '')}', ${index})">Modifica</button>
                `;
                container.appendChild(tipElement);
            });
            
            // Aggiunge un messaggio se non ci sono consigli
            if (tipsData.length === 0) {
                const emptyTipElement = document.createElement('li');
                emptyTipElement.textContent = "Nessun consiglio aggiunto. Usa il pulsante qui sotto per aggiungerne uno.";
                container.appendChild(emptyTipElement);
            }
        }

        function renderEmergencyNumbers() {
            const emergencyContainer = document.getElementById('emergency-container');
            emergencyContainer.innerHTML = '';

            emergencyData.forEach((emergency, index) => {
                const emergencyElement = document.createElement('div');
                emergencyElement.classList.add('emergency-item');
                emergencyElement.innerHTML = `
                    <div class="emergency-name">${emergency.name}</div>
                    <div class="emergency-number">${emergency.number}</div>
                    <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="showEditEmergencyModal(${index})">Modifica</button>
                `;
                emergencyContainer.appendChild(emergencyElement);
            });
            
            // Aggiunge un messaggio se non ci sono contatti
            if (emergencyData.length === 0) {
                const emptyEmergencyElement = document.createElement('div');
                emptyEmergencyElement.classList.add('emergency-item');
                emptyEmergencyElement.innerHTML = `
                    <div>Nessun contatto aggiunto.</div>
                    <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="showAddEmergencyModal()">Aggiungi contatto</button>
                `;
                emergencyContainer.appendChild(emptyEmergencyElement);
            }
        }

        // Funzioni per le modal
        function showEditActivityModal(dayId, activityId) {
            const day = itineraryData.find(d => d.id === dayId);
            const activity = day.activities.find(a => a.id === activityId);

            document.getElementById('edit-day-id').value = dayId;
            document.getElementById('edit-activity-id').value = activityId;
            document.getElementById('edit-activity-title').value = activity.title;
            document.getElementById('edit-activity-time').value = activity.time;
            document.getElementById('edit-activity-description').value = activity.description;
            document.getElementById('edit-activity-notes').value = activity.notes;

            const modal = document.getElementById('edit-activity-modal');
            modal.style.display = 'flex';
        }

        function showAddDayModal() {
            // Reset form
            document.getElementById('add-day-title').value = '';
            document.getElementById('add-day-date').valueAsDate = new Date();
            
            const modal = document.getElementById('add-day-modal');
            modal.style.display = 'flex';
        }

        function showAddActivityModal(dayId) {
            document.getElementById('add-activity-day-id').value = dayId;
            
            // Reset form
            document.getElementById('add-activity-title').value = '';
            document.getElementById('add-activity-time').value = '';
            document.getElementById('add-activity-description').value = '';
            document.getElementById('add-activity-notes').value = '';

            const modal = document.getElementById('add-activity-modal');
            modal.style.display = 'flex';
        }
        
        function showAddTipModal(category) {
            document.getElementById('add-tip-category').value = category;
            document.getElementById('add-tip-text').value = '';
            
            const modal = document.getElementById('add-tip-modal');
            modal.style.display = 'flex';
        }
        
        function showEditTipModal(category, index) {
            let tipText;
            if (category === 'general') {
                tipText = tipsGeneralData[index];
            } else if (category === 'transport') {
                tipText = tipsTransportData[index];
            } else if (category === 'attractions') {
                tipText = tipsAttractionsData[index];
            }
            
            document.getElementById('edit-tip-category').value = category;
            document.getElementById('edit-tip-id').value = index;
            document.getElementById('edit-tip-text').value = tipText;
            
            const modal = document.getElementById('edit-tip-modal');
            modal.style.display = 'flex';
        }
        
        function showAddEmergencyModal() {
            // Reset form
            document.getElementById('add-emergency-name').value = '';
            document.getElementById('add-emergency-number').value = '';
            
            const modal = document.getElementById('add-emergency-modal');
            modal.style.display = 'flex';
        }
        
        function showEditEmergencyModal(index) {
            const emergency = emergencyData[index];
            
            document.getElementById('edit-emergency-id').value = index;
            document.getElementById('edit-emergency-name').value = emergency.name;
            document.getElementById('edit-emergency-number').value = emergency.number;
            
            const modal = document.getElementById('edit-emergency-modal');
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        // Funzioni per la gestione dei dati
        function saveActivity() {
            const dayId = parseInt(document.getElementById('edit-day-id').value);
            const activityId = parseInt(document.getElementById('edit-activity-id').value);
            const title = document.getElementById('edit-activity-title').value;
            const time = document.getElementById('edit-activity-time').value;
            const description = document.getElementById('edit-activity-description').value;
            const notes = document.getElementById('edit-activity-notes').value;

            const day = itineraryData.find(d => d.id === dayId);
            const activity = day.activities.find(a => a.id === activityId);

            activity.title = title;
            activity.time = time;
            activity.description = description;
            activity.notes = notes;

            saveToLocalStorage();
            renderDays();
            closeModal('edit-activity-modal');
        }

        function saveNewActivity() {
            const dayId = parseInt(document.getElementById('add-activity-day-id').value);
            const title = document.getElementById('add-activity-title').value;
            const time = document.getElementById('add-activity-time').value;
            const description = document.getElementById('add-activity-description').value;
            const notes = document.getElementById('add-activity-notes').value;

            const day = itineraryData.find(d => d.id === dayId);
            
            // Trova il prossimo ID disponibile
            const activityIds = itineraryData.flatMap(d => d.activities.map(a => a.id));
            const newActivityId = activityIds.length > 0 ? Math.max(...activityIds) + 1 : 1;

            day.activities.push({
                id: newActivityId,
                title,
                time,
                description,
                completed: false,
                notes
            });

            saveToLocalStorage();
            renderDays();
            closeModal('add-activity-modal');
        }

        function addDay() {
            const title = document.getElementById('add-day-title').value;
            const date = document.getElementById('add-day-date').value;
            
            // Converti la data in formato leggibile
            const formattedDate = new Date(date).toLocaleDateString('it-IT', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            // Trova il prossimo ID disponibile
            const dayIds = itineraryData.map(d => d.id);
            const newDayId = dayIds.length > 0 ? Math.max(...dayIds) + 1 : 1;

            itineraryData.push({
                id: newDayId,
                title,
                date: formattedDate,
                activities: []
            });

            saveToLocalStorage();
            renderDays();
            closeModal('add-day-modal');
        }

        function deleteActivity() {
            const dayId = parseInt(document.getElementById('edit-day-id').value);
            const activityId = parseInt(document.getElementById('edit-activity-id').value);

            if (confirm('Sei sicuro di voler eliminare questa attivit√†?')) {
                const day = itineraryData.find(d => d.id === dayId);
                day.activities = day.activities.filter(a => a.id !== activityId);

                saveToLocalStorage();
                renderDays();
                closeModal('edit-activity-modal');
            }
        }

        function toggleActivityCompletion(dayId, activityId) {
            const day = itineraryData.find(d => d.id === dayId);
            const activity = day.activities.find(a => a.id === activityId);
            
            activity.completed = !activity.completed;
            
            saveToLocalStorage();
            renderDays();
        }
        
        function addTip() {
            const category = document.getElementById('add-tip-category').value;
            const tipText = document.getElementById('add-tip-text').value;
            
            if (category === 'general') {
                tipsGeneralData.push(tipText);
            } else if (category === 'transport') {
                tipsTransportData.push(tipText);
            } else if (category === 'attractions') {
                tipsAttractionsData.push(tipText);
            }
            
            saveToLocalStorage();
            renderTips();
            closeModal('add-tip-modal');
        }
        
        function saveTip() {
            const category = document.getElementById('edit-tip-category').value;
            const index = parseInt(document.getElementById('edit-tip-id').value);
            const tipText = document.getElementById('edit-tip-text').value;
            
            if (category === 'general') {
                tipsGeneralData[index] = tipText;
            } else if (category === 'transport') {
                tipsTransportData[index] = tipText;
            } else if (category === 'attractions') {
                tipsAttractionsData[index] = tipText;
            }
            
            saveToLocalStorage();
            renderTips();
            closeModal('edit-tip-modal');
        }
        
        function deleteTip() {
            const category = document.getElementById('edit-tip-category').value;
            const index = parseInt(document.getElementById('edit-tip-id').value);
            
            if (confirm('Sei sicuro di voler eliminare questo consiglio?')) {
                if (category === 'general') {
                    tipsGeneralData.splice(index, 1);
                } else if (category === 'transport') {
                    tipsTransportData.splice(index, 1);
                } else if (category === 'attractions') {
                    tipsAttractionsData.splice(index, 1);
                }
                
                saveToLocalStorage();
                renderTips();
                closeModal('edit-tip-modal');
            }
        }
        
        function addEmergency() {
            const name = document.getElementById('add-emergency-name').value;
            const number = document.getElementById('add-emergency-number').value;
            
            // Trova il prossimo ID disponibile
            const emergencyIds = emergencyData.map(e => e.id);
            const newEmergencyId = emergencyIds.length > 0 ? Math.max(...emergencyIds) + 1 : 1;
            
            emergencyData.push({
                id: newEmergencyId,
                name,
                number
            });
            
            saveToLocalStorage();
            renderEmergencyNumbers();
            closeModal('add-emergency-modal');
        }
        
        function saveEmergency() {
            const index = parseInt(document.getElementById('edit-emergency-id').value);
            const name = document.getElementById('edit-emergency-name').value;
            const number = document.getElementById('edit-emergency-number').value;
            
            emergencyData[index].name = name;
            emergencyData[index].number = number;
            
            saveToLocalStorage();
            renderEmergencyNumbers();
            closeModal('edit-emergency-modal');
        }
        
        function deleteEmergency() {
            const index = parseInt(document.getElementById('edit-emergency-id').value);
            
            if (confirm('Sei sicuro di voler eliminare questo contatto?')) {
                emergencyData.splice(index, 1);
                
                saveToLocalStorage();
                renderEmergencyNumbers();
                closeModal('edit-emergency-modal');
            }
        }
        
        // Funzione per cancellare tutti i dati
        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati? Questa azione non pu√≤ essere annullata.')) {
                localStorage.clear();
                
                // Reimposta i dati alle impostazioni predefinite
                document.getElementById('main-title').innerText = 'Il Mio Viaggio';
                itineraryData = [];

                tipsGeneralData = [
                    "Esempio: Verifica i documenti necessari per il viaggio",
                    "Esempio: Controlla le previsioni meteo prima della partenza",
                    "Esempio: Porta con te medicinali di base"
                ];

                tipsTransportData = [
                    "Esempio: Verifica gli orari dei mezzi pubblici in anticipo",
                    "Esempio: Considera l'acquisto di biglietti o pass per pi√π giorni",
                    "Esempio: Scarica l'app per la mobilit√† locale"
                ];

                tipsAttractionsData = [
                    "Esempio: Prenota le attrazioni principali in anticipo",
                    "Esempio: Verifica gli orari di apertura e chiusura",
                    "Esempio: Cerca sconti o offerte per gruppi/famiglie"
                ];

                emergencyData = [
                    {
                        id: 1,
                        name: "Emergenze",
                        number: "112"
                    },
                    {
                        id: 2,
                        name: "Esempio: Hotel",
                        number: "+00 123 456789"
                    },
                    {
                        id: 3,
                        name: "Esempio: Contatto locale",
                        number: "+00 987 654321"
                    }
                ];
                
                renderAll();
                updateManifest();
                showNotification('Tutti i dati sono stati cancellati');
            }
        }

        // Funzione per esportare il programma come diario di viaggio
        function exportItinerary() {
            const mainTitle = document.getElementById('main-title').innerText;
            let exportText = `# ${mainTitle}\n\n`;
            
            itineraryData.forEach(day => {
                exportText += `## ${day.title} - ${day.date}\n\n`;
                
                day.activities.forEach(activity => {
                    exportText += `### ${activity.title} (${activity.time})\n`;
                    exportText += `${activity.description}\n`;
                    
                    if (activity.notes) {
                        exportText += `\n**Note personali:**\n${activity.notes}\n`;
                    }
                    
                    if (activity.completed) {
                        exportText += `\n‚úÖ Completato\n`;
                    }
                    
                    exportText += "\n";
                });
                
                exportText += "---\n\n";
            });
            
            // Aggiungi sezione consigli
            exportText += "# Consigli Utili\n\n";
            
            exportText += "## Per il viaggio:\n";
            tipsGeneralData.forEach(tip => {
                exportText += `- ${tip}\n`;
            });
            exportText += "\n";
            
            exportText += "## Per gli spostamenti:\n";
            tipsTransportData.forEach(tip => {
                exportText += `- ${tip}\n`;
            });
            exportText += "\n";
            
            exportText += "## Per le attrazioni:\n";
            tipsAttractionsData.forEach(tip => {
                exportText += `- ${tip}\n`;
            });
            exportText += "\n";
            
            // Aggiungi sezione numeri utili
            exportText += "# Numeri Utili\n\n";
            emergencyData.forEach(emergency => {
                exportText += `- **${emergency.name}**: ${emergency.number}\n`;
            });
            
            // Crea un elemento per il download
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(exportText));
            
            // Crea un nome file basato sul titolo
            const fileName = mainTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            element.setAttribute('download', `${fileName}_diario.md`);
            
            element.style.display = 'none';
            document.body.appendChild(element);
            
            element.click();
            
            document.body.removeChild(element);
            showNotification('Diario esportato con successo');
        }
        
        // Manifest per funzionalit√† PWA/Standalone
        function generateManifest() {
            const mainTitle = document.getElementById('main-title').innerText || 'Pianifica Viaggio';
            const manifestData = {
                name: mainTitle,
                short_name: mainTitle,
                description: 'App per pianificare e organizzare viaggi',
                start_url: window.location.href,
                display: 'standalone',
                background_color: '#f5f5f5',
                theme_color: '#1976d2',
                icons: [
                    {
                        src: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjIwIiBmaWxsPSIjMTk3NmQyIi8+PHBhdGggZD0iTTMwIDMwIEw3MCAzMCBMNzAgNzAgTDMwIDcwIFoiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iNCIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0zNSA0MCBMNTM1IDQwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiLz48cGF0aCBkPSJNMzUgNTAgTDUzNSA1MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PHBhdGggZD0iTTM1IDYwIEw1MzUgNjAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMyIvPjwvc3ZnPg==',
                        sizes: '512x512',
                        type: 'image/svg+xml',
                        purpose: 'any'
                    }
                ]
            };
            
            return 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifestData));
        }
        
        // Aggiorna il manifest quando cambia il titolo
        function updateManifest() {
            const manifestLink = document.querySelector('link[rel="manifest"]');
            manifestLink.href = generateManifest();
        }
        
        // Installa la PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('Applicazione installata con successo');
                    }
                    deferredPrompt = null;
                });
            } else {
                showInstallInstructions();
            }
        }
        
        function showInstallInstructions() {
            alert('Per installare l\'applicazione:\n\n' +
                  '- Su Chrome/Edge (desktop): Clicca sull\'icona di installazione nella barra degli indirizzi\n' +
                  '- Su Safari (iOS): Clicca su "Condividi" e poi "Aggiungi a Home"\n' +
                  '- Su Chrome (Android): Menu > Installa app');
        }

        // Funzione per mostrare notifiche
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Variabile per l'installazione PWA
        let deferredPrompt;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            // Inizializza il manifest
            updateManifest();
            
            // Gestione dell'installazione PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-button').style.display = 'flex';
            });
            
            // Carica i dati dal localStorage se disponibili
            if (localStorage.getItem('itineraryData')) {
                loadFromLocalStorage();
            } else {
                renderAll();
            }
            
            // Aggiornamento manifest quando cambia il titolo
            const mainTitle = document.getElementById('main-title');
            mainTitle.addEventListener('blur', () => {
                saveToLocalStorage();
                updateManifest();
            });
            
            // Aggiungi listener per i tasti Escape per chiudere i modal
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal('edit-activity-modal');
                    closeModal('add-day-modal');
                    closeModal('add-activity-modal');
                    closeModal('add-tip-modal');
                    closeModal('edit-tip-modal');
                    closeModal('add-emergency-modal');
                    closeModal('edit-emergency-modal');
                }
            });
            
            // Verifica se l'app √® in modalit√† standalone
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                showNotification('App avviata in modalit√† standalone');
            }
        });

// Funzione per esportare tutti i dati in formato JSON
function exportDataToJson() {
    const dataToExport = {
        mainTitle: document.getElementById('main-title').innerText,
        itineraryData: itineraryData,
        tipsGeneralData: tipsGeneralData,
        tipsTransportData: tipsTransportData,
        tipsAttractionsData: tipsAttractionsData,
        emergencyData: emergencyData
    };
    
    // Crea un elemento per il download
    const element = document.createElement('a');
    const jsonString = JSON.stringify(dataToExport, null, 2);
    element.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(jsonString));
    
    // Crea un nome file basato sul titolo
    const fileName = document.getElementById('main-title').innerText.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    element.setAttribute('download', `${fileName}_dati.json`);
    
    element.style.display = 'none';
    document.body.appendChild(element);
    
    element.click();
    
    document.body.removeChild(element);
    showNotification('Dati esportati con successo in formato JSON');
}

// Funzione per importare dati da un file JSON
function importDataFromJson() {
    // Crea un input file invisibile
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = e => {
        const file = e.target.files[0];
        
        if (!file) {
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const importedData = JSON.parse(event.target.result);
                
                // Verifica che il file contenga i dati necessari
                if (!importedData.itineraryData || 
                    !importedData.tipsGeneralData || 
                    !importedData.tipsTransportData || 
                    !importedData.tipsAttractionsData || 
                    !importedData.emergencyData) {
                    throw new Error('Il file JSON non contiene tutti i dati necessari');
                }
                
                // Aggiorna i dati
                document.getElementById('main-title').innerText = importedData.mainTitle || 'Il Mio Viaggio';
                itineraryData = importedData.itineraryData;
                tipsGeneralData = importedData.tipsGeneralData;
                tipsTransportData = importedData.tipsTransportData;
                tipsAttractionsData = importedData.tipsAttractionsData;
                emergencyData = importedData.emergencyData;
                
                // Salva e renderizza
                saveToLocalStorage();
                renderAll();
                updateManifest();
                
                showNotification('Dati importati con successo');
            } catch (error) {
                showNotification('Errore: impossibile importare i dati');
                console.error('Errore durante l\'importazione:', error);
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}
    </script>
</body>
</html>
