<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#144B82">
    <title>Appunti di Viaggio</title>
    <link rel="manifest" href="#manifest" crossorigin="use-credentials">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-title" content="Appunti di Viaggio">
    
    <!-- Marked.js per il supporto Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    
    <script>
        // Configura marked.js
        marked.setOptions({
            breaks: true,        // Converte i ritorni a capo in <br>
            gfm: true,           // Supporta GitHub Flavored Markdown
            headerIds: false,    // Disabilita gli ID degli header
            sanitize: false,     // HTML √® permesso
            smartLists: true,    // Liste pi√π belle
            smartypants: true,   // Tipografia migliorata (virgolette, trattini)
            xhtml: false         // Non usare XHTML
        }
        
        function moveActivityToDay(fromDayId, activityId, toDayId) {
            const fromDay = itineraryData.find(d => d.id === fromDayId);
            const toDay = itineraryData.find(d => d.id === toDayId);
            
            if (!fromDay || !toDay) return;
            
            const activityIndex = fromDay.activities.findIndex(a => a.id === activityId);
            if (activityIndex === -1) return;
            
            const activity = fromDay.activities[activityIndex];
            fromDay.activities.splice(activityIndex, 1);
            toDay.activities.push(activity);
            
            saveToLocalStorage();
            renderDays();
            enableAllReordering();
        }

        // Muovi un'attivit√† verso l'alto nella lista
        function moveActivityUp(dayId, activityId) {
            const day = itineraryData.find(d => d.id === dayId);
            if (!day) return;
            
            const activityIndex = day.activities.findIndex(activity => activity.id === activityId);
            
            // Se l'attivit√† √® gi√† in cima, non fare nulla
            if (activityIndex <= 0) return;
            
            // Scambia la posizione con l'attivit√† sopra
            [day.activities[activityIndex], day.activities[activityIndex - 1]] = 
            [day.activities[activityIndex - 1], day.activities[activityIndex]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderDays();
            // Riabilita il riordinamento per le attivit√† del giorno
            enableActivityReordering(dayId);
        }

        // Muovi un'attivit√† verso il basso nella lista
        function moveActivityDown(dayId, activityId) {
            const day = itineraryData.find(d => d.id === dayId);
            if (!day) return;
            
            const activityIndex = day.activities.findIndex(activity => activity.id === activityId);
            
            // Se l'attivit√† √® gi√† in fondo, non fare nulla
            if (activityIndex >= day.activities.length - 1) return;
            
            // Scambia la posizione con l'attivit√† sotto
            [day.activities[activityIndex], day.activities[activityIndex + 1]] = 
            [day.activities[activityIndex + 1], day.activities[activityIndex]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderDays();
            // Riabilita il riordinamento per le attivit√† del giorno
            enableActivityReordering(dayId);
        }

        // Abilita il riordinamento per i consigli
        function enableTipsReordering(category) {
            const tipsContainer = document.getElementById(`tips-${category}`);
            if (!tipsContainer) return;
            
            const tipItems = tipsContainer.querySelectorAll('.tip-item');
            
            tipItems.forEach((tipItem, index) => {
                // Verifica se i pulsanti sono gi√† presenti
                if (!tipItem.querySelector('.tip-reorder-buttons')) {
                    // Crea il contenitore dei pulsanti
                    const reorderButtons = document.createElement('div');
                    reorderButtons.className = 'tip-reorder-buttons';
                    reorderButtons.style.display = 'flex';
                    reorderButtons.style.gap = '0.5rem';
                    
                    // Pulsante "Sposta su"
                    const upButton = document.createElement('button');
                    upButton.className = 'btn btn-secondary';
                    upButton.innerHTML = '‚Üë';
                    upButton.style.padding = '0.25rem 0.5rem';
                    upButton.style.fontSize = '0.8rem';
                    upButton.title = 'Sposta su';
                    upButton.onclick = (e) => {
                        e.stopPropagation();
                        moveTipUp(category, index);
                    };
                    
                    // Pulsante "Sposta gi√π"
                    const downButton = document.createElement('button');
                    downButton.className = 'btn btn-secondary';
                    downButton.innerHTML = '‚Üì';
                    downButton.style.padding = '0.25rem 0.5rem';
                    downButton.style.fontSize = '0.8rem';
                    downButton.title = 'Sposta gi√π';
                    downButton.onclick = (e) => {
                        e.stopPropagation();
                        moveTipDown(category, index);
                    };
                    
                    // Aggiungi i pulsanti al contenitore
                    reorderButtons.appendChild(upButton);
                    reorderButtons.appendChild(downButton);
                    
                    // Inserisci il contenitore dei pulsanti prima del pulsante modifica
                    tipItem.insertBefore(reorderButtons, tipItem.querySelector('button'));
                }
            });
        }

        // Muovi un consiglio verso l'alto
        function moveTipUp(category, index) {
            let tipsData;
            
            // Seleziona l'array corretto in base alla categoria
            if (category === 'general') {
                tipsData = tipsGeneralData;
            } else if (category === 'transport') {
                tipsData = tipsTransportData;
            } else if (category === 'attractions') {
                tipsData = tipsAttractionsData;
            }
            
            // Se il consiglio √® gi√† in cima, non fare nulla
            if (index <= 0 || !tipsData) return;
            
            // Scambia la posizione con il consiglio sopra
            [tipsData[index], tipsData[index - 1]] = [tipsData[index - 1], tipsData[index]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderTips();
            // Riabilita il riordinamento per i consigli
            enableTipsReordering('general');
            enableTipsReordering('transport');
            enableTipsReordering('attractions');
        }

        // Muovi un consiglio verso il basso
        function moveTipDown(category, index) {
            let tipsData;
            
            // Seleziona l'array corretto in base alla categoria
            if (category === 'general') {
                tipsData = tipsGeneralData;
            } else if (category === 'transport') {
                tipsData = tipsTransportData;
            } else if (category === 'attractions') {
                tipsData = tipsAttractionsData;
            }
            
            // Se il consiglio √® gi√† in fondo, non fare nulla
            if (index >= tipsData.length - 1 || !tipsData) return;
            
            // Scambia la posizione con il consiglio sotto
            [tipsData[index], tipsData[index + 1]] = [tipsData[index + 1], tipsData[index]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderTips();
            // Riabilita il riordinamento per i consigli
            enableTipsReordering('general');
            enableTipsReordering('transport');
            enableTipsReordering('attractions');
        }

        // Abilita il riordinamento per i contatti di emergenza
        function enableEmergencyReordering() {
            const emergencyContainer = document.getElementById('emergency-container');
            if (!emergencyContainer) return;
            
            const emergencyItems = emergencyContainer.querySelectorAll('.emergency-item');
            
            emergencyItems.forEach((item, index) => {
                // Verifica se i pulsanti sono gi√† presenti
                if (!item.querySelector('.emergency-reorder-buttons')) {
                    // Crea il contenitore dei pulsanti
                    const reorderButtons = document.createElement('div');
                    reorderButtons.className = 'emergency-reorder-buttons';
                    reorderButtons.style.display = 'flex';
                    reorderButtons.style.gap = '0.5rem';
                    reorderButtons.style.marginTop = '0.5rem';
                    
                    // Pulsante "Sposta su"
                    const upButton = document.createElement('button');
                    upButton.className = 'btn btn-secondary';
                    upButton.innerHTML = '‚Üë';
                    upButton.style.padding = '0.25rem 0.5rem';
                    upButton.style.fontSize = '0.8rem';
                    upButton.title = 'Sposta su';
                    upButton.onclick = (e) => {
                        e.stopPropagation();
                        moveEmergencyUp(index);
                    };
                    
                    // Pulsante "Sposta gi√π"
                    const downButton = document.createElement('button');
                    downButton.className = 'btn btn-secondary';
                    downButton.innerHTML = '‚Üì';
                    downButton.style.padding = '0.25rem 0.5rem';
                    downButton.style.fontSize = '0.8rem';
                    downButton.title = 'Sposta gi√π';
                    downButton.onclick = (e) => {
                        e.stopPropagation();
                        moveEmergencyDown(index);
                    };
                    
                    // Aggiungi i pulsanti al contenitore
                    reorderButtons.appendChild(upButton);
                    reorderButtons.appendChild(downButton);
                    
                    // Inserisci il contenitore dei pulsanti prima del pulsante modifica
                    item.insertBefore(reorderButtons, item.querySelector('button'));
                }
            });
        }

        // Muovi un contatto di emergenza verso l'alto
        function moveEmergencyUp(index) {
            // Se il contatto √® gi√† in cima, non fare nulla
            if (index <= 0) return;
            
            // Scambia la posizione con il contatto sopra
            [emergencyData[index], emergencyData[index - 1]] = [emergencyData[index - 1], emergencyData[index]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderEmergencyNumbers();
            // Riabilita il riordinamento
            enableEmergencyReordering();
        }

        // Muovi un contatto di emergenza verso il basso
        function moveEmergencyDown(index) {
            // Se il contatto √® gi√† in fondo, non fare nulla
            if (index >= emergencyData.length - 1) return;
            
            // Scambia la posizione con il contatto sotto
            [emergencyData[index], emergencyData[index + 1]] = [emergencyData[index + 1], emergencyData[index]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderEmergencyNumbers();
            // Riabilita il riordinamento
            enableEmergencyReordering();
        }

        // Abilita tutte le funzionalit√† di riordinamento
        function enableAllReordering() {
            enableDayReordering();
            
            // Abilita il riordinamento delle attivit√† per ogni giorno
            itineraryData.forEach(day => {
                enableActivityReordering(day.id);
            });
            
            // Abilita il riordinamento per i consigli
            enableTipsReordering('general');
            enableTipsReordering('transport');
            enableTipsReordering('attractions');
            
            // Abilita il riordinamento per i contatti di emergenza
            enableEmergencyReordering();

            // Assicurati che i pulsanti di modifica giorno siano ancora visibili
            addEditButtonsToDays();
        }

        function renderAll() {
            renderDays();
            renderTips();
            renderEmergencyNumbers();
            // Se la modalit√† riordinamento √® attiva
            if (document.getElementById('toggle-reorder-mode').classList.contains('active')) {
                enableAllReordering();
            }
        });
    </script>
    
    <style>
        :root {
            --primary: #144B82;
            --primary-dark: #1565c0;
            --secondary: #ff4081;
            --light-gray: #f5f5f5;
            --gray: #e0e0e0;
            --dark-gray: #757575;
            --white: #ffffff;
            --black: #212121;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-gray);
            color: var(--black);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    
        .logo h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .logo h1[contenteditable="true"]:focus {
            outline: 2px dashed var(--secondary);
            padding: 0.2rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1rem;
        }
        
        nav a {
            color: var(--white);
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav a:hover {
            background-color: var(--primary-dark);
        }
        
        main {
            margin: 2rem 0;
        }
        
        .section {
            margin-bottom: 2rem;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray);
        }
        
        .section-title {
            font-size: 1.25rem;
            color: var(--primary);
        }
        
        .day {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed var(--gray);
        }
        
        .day:last-child {
            border-bottom: none;
        }

        .day-header {
            display: flex;
            flex-direction: column; /* Cambia da row a column */
            align-items: flex-start; /* Allinea a sinistra */
            background-color: var(--primary);
            color: var(--white);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            gap: 0.25rem; /* Aggiunge spazio tra gli elementi */
        }
        
        .day-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem; /* Aggiungi margine inferiore se necessario */
        }
        
        .day-date {
            font-size: 0.9rem;
            opacity: 0.9; /* Opzionale: rendi la data leggermente pi√π chiara */
        }
        
        .activity {
            background-color: var(--light-gray);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .activity:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .activity-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .activity-time {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }
        
        .activity-description {
            margin-bottom: 1rem;
            white-space: pre-line; /* Preserva gli spazi e le interruzioni di riga */
        }
        
        .edit-activity {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .activity-notes {
            border-top: 1px solid var(--gray);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            font-style: italic;
            white-space: pre-line; /* Preserva gli spazi e le interruzioni di riga */
        }
        
        .tips-list {
            padding-left: 1.5rem;
        }
        
        .tips-list li {
            margin-bottom: 0.5rem;
        }
        
        .emergency-card {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .emergency-item {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .emergency-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .emergency-number {
            font-size: 1.25rem;
            color: var(--error);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--white);
            margin-bottom: 0.25rem; /* Aggiungi margine inferiore se necessario */
        }
        
        .btn-secondary:hover {
            background-color: #e91e63;
        }
        
        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }
        
        .btn-success:hover {
            background-color: #388e3c;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--white);
        }
        
        .btn-warning:hover {
            background-color: #f57c00;
        }
        
        .btn-error {
            background-color: var(--error);
            color: var(--white);
        }
        
        .btn-error:hover {
            background-color: #d32f2f;
        }
        
        .btn-google {
            background-color: #4285f4;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-google:hover {
            background-color: #357abd;
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .checkbox-label input {
            width: 18px;
            height: 18px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray);
        }
        
        .modal-title {
            font-size: 1.25rem;
            color: var(--primary);
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--dark-gray);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .floating-action {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .fab-primary {
            background-color: var(--primary);
            color: var(--white);
        }
        
        .fab-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .fab-secondary {
            background-color: var(--secondary);
            color: var(--white);
        }
        
        .fab-secondary:hover {
            background-color: #e91e63;
        }
        
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        /* Stili per selezione tema */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1rem 0;
        }

        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 1rem;
            border-radius: 8px;
            transition: background-color 0.3s;
            background-color: var(--light-gray); /* Aggiunto */
        }

        .theme-option:hover {
            background-color: var(--light-gray);
        }

        .theme-preview {
            width: 100px;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 2px solid var(--gray);
        }

        .default-theme {
            background: linear-gradient(135deg, #144B82 0%, #1565c0 50%, #ff4081 50%, #e91e63 100%);
        }

        .green-theme {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 50%, #ff9800 50%, #f57c00 100%);
        }

        .purple-theme {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 50%, #ff5722 50%, #e64a19 100%);
        }
        
        .gray-theme {
            background: linear-gradient(135deg, #757575 0%, #616161 50%, #9e9e9e 50%, #bdbdbd 100%);
        }

        /* Stili per i temi alternativi */
        body.green-theme {
            --primary: #4caf50;
            --primary-dark: #388e3c;
            --secondary: #ff9800;
            --success: #2196f3;
            --warning: #ff5722;
            --error: #f44336;
            background-color: var(--light-gray); /* Aggiunto */
        }

        body.purple-theme {
            --primary: #9c27b0;
            --primary-dark: #7b1fa2;
            --secondary: #ff5722;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            background-color: var(--light-gray); /* Aggiunto */
        }
        
        /* Nuovo tema grigio */
        body.gray-theme {
            --primary: #757575;
            --primary-dark: #616161;
            --secondary: #9e9e9e;
            --success: #78909c;
            --warning: #b0bec5;
            --error: #607d8b;
            background-color: var(--white);
        }

        .activity-title span.completed,
        .activity-time.completed,
        .activity-description.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* Mantieni lo stile originale per le note */
        .activity-notes {
            opacity: 1 !important;
            text-decoration: none !important;
        }
        
        #notification {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
            z-index: 900;
        }
        
        .add-item-btn {
            width: 100%;
            margin-top: 1rem;
        }
        
        .tip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .tip-item button {
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .hidden-notes .activity-notes,
        .hidden-descriptions .activity-description {
            display: none;
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .section {
                padding: 1rem;
            }
            
            .day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .activity-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .fab {
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }

            section[id] {
                padding-top: 20px;
                margin-top: -20px; /* Compensa il padding */
                display: inline-block;
                width: 100%;
                scroll-margin-top: 70px;
            }

            .section-header > div {
                display: flex;
                gap: 0.5rem;
            }
        }
        
        /* Stili per il contenuto Markdown */
        .activity-description h1, .activity-notes h1,
        .tip-item span h1 {
            font-size: 1.4rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .activity-description h2, .activity-notes h2,
        .tip-item span h2 {
            font-size: 1.3rem;
            margin-top: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .activity-description h3, .activity-notes h3,
        .tip-item span h3 {
            font-size: 1.2rem;
            margin-top: 0.6rem;
            margin-bottom: 0.3rem;
        }

        .activity-description p, .activity-notes p,
        .tip-item span p {
            margin-bottom: 0.8rem;
        }

        .activity-description ul, .activity-notes ul,
        .tip-item span ul,
        .activity-description ol, .activity-notes ol,
        .tip-item span ol {
            padding-left: 2rem;
            margin-bottom: 0.8rem;
        }

        .activity-description code, .activity-notes code,
        .tip-item span code {
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .activity-description pre, .activity-notes pre,
        .tip-item span pre {
            background-color: #f0f0f0;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 0.8rem;
        }

        .activity-description blockquote, .activity-notes blockquote,
        .tip-item span blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin-left: 0;
            color: var(--dark-gray);
        }

        .activity-description img, .activity-notes img,
        .tip-item span img {
            max-width: 100%;
            height: auto;
        }

        .activity-description a, .activity-notes a,
        .tip-item span a {
            color: var(--primary);
            text-decoration: underline;
        }

        /* Mantieni i link cliccabili anche quando l'attivit√† √® completata */
        .activity-description.completed a, 
        .activity-notes a {
            opacity: 1;
            text-decoration: underline;
        }

        /* Stile tabelle Markdown */
        .activity-description table, .activity-notes table,
        .tip-item span table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
        }

        .activity-description th, .activity-notes th,
        .tip-item span th,
        .activity-description td, .activity-notes td,
        .tip-item span td {
            border: 1px solid var(--gray);
            padding: 8px;
            text-align: left;
        }

        .activity-description th, .activity-notes th,
        .tip-item span th {
            background-color: var(--light-gray);
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">
                <h1 contenteditable="true" id="main-title">Appunti di Viaggio</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="#programma">Programma</a></li>
                    <li><a href="#consigli">Consigli</a></li>
                    <li><a href="#numeri-utili">Numeri</a></li>
                    <li><a href="#export-options">Opzioni</a></li>
                </ul>
            </nav>
        </div>

        <div align="center">
            <button class="btn btn-secondary" onclick="toggleAllNotes()">
                <span>Mostra/Nascondi Note</span>
            </button>
            <button class="btn btn-secondary" onclick="toggleAllDescriptions()">
                <span>Mostra/Nascondi Descrizioni</span>
            </button>
            <button id="toggle-reorder-mode" class="btn btn-secondary">
                <span>Modalit√† Riordinamento</span>
            </button>
        </div>
          
    </header>
    
    <main class="container">
        <section id="programma" class="section">
            <div class="section-header">
                <h2 class="section-title">Programma del Viaggio</h2>
            </div>
            
            <div id="days-container">
                <!-- Il contenuto verr√† popolato con JavaScript -->
            </div>
        </section>
        
        <section id="consigli" class="section">
            <div class="section-header">
                <h2 class="section-title">Consigli Utili</h2>
            </div>
            
            <div class="tips-container">
                <h3>Per il viaggio:</h3>
                <ul class="tips-list" id="tips-general">
                    <!-- Il contenuto verr√† popolato con JavaScript -->
                </ul>
                <button class="btn btn-secondary add-item-btn" onclick="showAddTipModal('general')">Aggiungi Consiglio</button>
                
                <h3>Per gli spostamenti:</h3>
                <ul class="tips-list" id="tips-transport">
                    <!-- Il contenuto verr√† popolato con JavaScript -->
                </ul>
                <button class="btn btn-secondary add-item-btn" onclick="showAddTipModal('transport')">Aggiungi Consiglio</button>
                
                <h3>Per le attrazioni:</h3>
                <ul class="tips-list" id="tips-attractions">
                    <!-- Il contenuto verr√† popolato con JavaScript -->
                </ul>
                <button class="btn btn-secondary add-item-btn" onclick="showAddTipModal('attractions')">Aggiungi Consiglio</button>
            </div>
        </section>
        
        <section id="numeri-utili" class="section">
            <div class="section-header">
                <h2 class="section-title">Numeri Utili</h2>
                <button class="btn btn-secondary" onclick="showAddEmergencyModal()">Aggiungi Contatto</button>
            </div>
            
            <div class="emergency-card" id="emergency-container">
                <!-- Il contenuto verr√† popolato con JavaScript -->
            </div>
        </section>

        <section id="export-options" class="section">
            <div class="section-header">
                <h2 class="section-title">Opzioni di Esportazione e Gestione Dati</h2>
            </div>
            
            <div style="padding: 1.5rem; text-align: center;">
                <button class="btn btn-primary" onclick="exportItinerary()">
                    <span>Esporta Diario</span>
                </button>
                &nbsp;&nbsp;&nbsp;
                <button class="btn btn-primary" onclick="showThemeSelector()">
                    <span>Cambia Tema</span>
                </button>
                <br> <br><hr><br>
                
                <button class="btn btn-primary" onclick="exportDataToJson()">
                    <span>Esporta file</span>
                </button>
                &nbsp;&nbsp;&nbsp;
                
                <button class="btn btn-primary" onclick="importDataFromJson()">
                    <span>Importa file</span>
                </button>
                <br><br><hr><br>

                <button class="btn btn-primary" onclick="archiveCurrentTrip()">
                    <span>Archivia Viaggio</span>
                </button>
                &nbsp;&nbsp;&nbsp;
                <button class="btn btn-primary" onclick="openArchivePage()">
                    <span>Apri Archivio</span>
                </button>
                <br><br><hr><br>
                
                <button class="btn btn-primary" onclick="exportArchiveToJson()">
                    <span>Esporta Archivio</span>
                </button>
                &nbsp;&nbsp;&nbsp;

                <button class="btn btn-primary" onclick="importArchiveFromJson()">
                    <span>Importa Archivio</span>
                </button>
                <br><br><hr><br>
                
                <button class="btn btn-error" onclick="clearAllData()">
                    <span>Cancella Tutti i Dati</span>
                </button>
            </div>
        </section>

    </main>
    
    <div class="floating-action">
        <button class="fab fab-secondary" onclick="installPWA()" id="install-button" style="display: none;">üì±</button>
        <button class="fab fab-primary" onclick="showAddDayModal()" title="Aggiungi giornata">+</button>
    </div>
    
    <div id="notification"></div>
    
    <!-- Modal per modificare attivit√† -->
    <div id="edit-activity-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifica Attivit√†</h3>
                <span class="close-modal" onclick="closeModal('edit-activity-modal')">&times;</span>
            </div>
            <form id="edit-activity-form">
                <input type="hidden" id="edit-day-id">
                <input type="hidden" id="edit-activity-id">
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-title">Titolo</label>
                    <input type="text" class="form-control" id="edit-activity-title" required placeholder="Inserisci il titolo dell'attivit√†">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-time">Orario</label>
                    <input type="text" class="form-control" id="edit-activity-time" placeholder="es. 09:00 - 12:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-description">Descrizione</label>
                    <details style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--primary);">Sintassi Markdown supportata</summary>
                        <div style="background-color: var(--light-gray); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                            <p><strong>Formattazione base:</strong></p>
                            <ul style="padding-left: 1.5rem;">
                                <li><code>**grassetto**</code> per <strong>grassetto</strong></li>
                                <li><code>*corsivo*</code> per <em>corsivo</em></li>
                                <li><code>[Link](https://example.com)</code> per <a href="#">link</a></li>
                                <li><code>- elemento</code> per liste puntate</li>
                                <li><code>1. elemento</code> per liste numerate</li>
                                <li><code># Titolo</code> per titoli</li>
                                <li><code>## Sottotitolo</code> per sottotitoli</li>
                                <li><code>![Alt text](URL immagine)</code> per immagini</li>
                                <li><code>`codice`</code> per <code>codice inline</code></li>
                            </ul>
                        </div>
                    </details>
                    <textarea class="form-control" id="edit-activity-description" rows="4" placeholder="Descrivi cosa farai durante questa attivit√†..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-activity-notes">Note Personali</label>
                    <details style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--primary);">Sintassi Markdown supportata</summary>
                        <div style="background-color: var(--light-gray); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                            <p><strong>Formattazione base:</strong></p>
                            <ul style="padding-left: 1.5rem;">
                                <li><code>**grassetto**</code> per <strong>grassetto</strong></li>
                                <li><code>*corsivo*</code> per <em>corsivo</em></li>
                                <li><code>[Link](https://example.com)</code> per <a href="#">link</a></li>
                                <li><code>- elemento</code> per liste puntate</li>
                                <li><code>1. elemento</code> per liste numerate</li>
                                <li><code># Titolo</code> per titoli</li>
                                <li><code>## Sottotitolo</code> per sottotitoli</li>
                                <li><code>![Alt text](URL immagine)</code> per immagini</li>
                                <li><code>`codice`</code> per <code>codice inline</code></li>
                            </ul>
                        </div>
                    </details>
                    <textarea class="form-control" id="edit-activity-notes" rows="3" placeholder="Aggiungi le tue note personali qui..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-error" onclick="deleteActivity()">Elimina</button>
                    <button type="button" class="btn btn-primary" onclick="saveActivity()">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere giorno -->
    <div id="add-day-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Giorno</h3>
                <span class="close-modal" onclick="closeModal('add-day-modal')">&times;</span>
            </div>
            <form id="add-day-form">
                <div class="form-group">
                    <label class="form-label" for="add-day-title">Titolo</label>
                    <input type="text" class="form-control" id="add-day-title" required placeholder="es. Primo giorno - Arrivo a destinazione">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-day-date">Data</label>
                    <input type="date" class="form-control" id="add-day-date" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="addDay()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere attivit√† -->
    <div id="add-activity-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Attivit√†</h3>
                <span class="close-modal" onclick="closeModal('add-activity-modal')">&times;</span>
            </div>
            <form id="add-activity-form">
                <input type="hidden" id="add-activity-day-id">
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-title">Titolo</label>
                    <input type="text" class="form-control" id="add-activity-title" required placeholder="es. Visita museo, Pranzo, Escursione...">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-time">Orario</label>
                    <input type="text" class="form-control" id="add-activity-time" placeholder="es. 09:00 - 12:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-description">Descrizione</label>
                    <details style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--primary);">Sintassi Markdown supportata</summary>
                        <div style="background-color: var(--light-gray); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                            <p><strong>Formattazione base:</strong></p>
                            <ul style="padding-left: 1.5rem;">
                                <li><code>**grassetto**</code> per <strong>grassetto</strong></li>
                                <li><code>*corsivo*</code> per <em>corsivo</em></li>
                                <li><code>[Link](https://example.com)</code> per <a href="#">link</a></li>
                                <li><code>- elemento</code> per liste puntate</li>
                                <li><code>1. elemento</code> per liste numerate</li>
                                <li><code># Titolo</code> per titoli</li>
                                <li><code>## Sottotitolo</code> per sottotitoli</li>
                                <li><code>![Alt text](URL immagine)</code> per immagini</li>
                                <li><code>`codice`</code> per <code>codice inline</code></li>
                            </ul>
                        </div>
                    </details>
                    <textarea class="form-control" id="add-activity-description" rows="4" placeholder="Descrivi cosa farai durante questa attivit√†..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-activity-notes">Note Personali</label>
                    <details style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--primary);">Sintassi Markdown supportata</summary>
                        <div style="background-color: var(--light-gray); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                            <p><strong>Formattazione base:</strong></p>
                            <ul style="padding-left: 1.5rem;">
                                <li><code>**grassetto**</code> per <strong>grassetto</strong></li>
                                <li><code>*corsivo*</code> per <em>corsivo</em></li>
                                <li><code>[Link](https://example.com)</code> per <a href="#">link</a></li>
                                <li><code>- elemento</code> per liste puntate</li>
                                <li><code>1. elemento</code> per liste numerate</li>
                                <li><code># Titolo</code> per titoli</li>
                                <li><code>## Sottotitolo</code> per sottotitoli</li>
                                <li><code>![Alt text](URL immagine)</code> per immagini</li>
                                <li><code>`codice`</code> per <code>codice inline</code></li>
                            </ul>
                        </div>
                    </details>
                    <textarea class="form-control" id="add-activity-notes" rows="3" placeholder="Aggiungi le tue note personali qui..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="saveNewActivity()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere consiglio -->
    <div id="add-tip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Consiglio</h3>
                <span class="close-modal" onclick="closeModal('add-tip-modal')">&times;</span>
            </div>
            <form id="add-tip-form">
                <input type="hidden" id="add-tip-category">
                
                <div class="form-group">
                    <label class="form-label" for="add-tip-text">Consiglio</label>
                    <details style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--primary);">Sintassi Markdown supportata</summary>
                        <div style="background-color: var(--light-gray); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                            <p><strong>Formattazione base:</strong></p>
                            <ul style="padding-left: 1.5rem;">
                                <li><code>**grassetto**</code> per <strong>grassetto</strong></li>
                                <li><code>*corsivo*</code> per <em>corsivo</em></li>
                                <li><code>[Link](https://example.com)</code> per <a href="#">link</a></li>
                                <li><code>- elemento</code> per liste puntate</li>
                                <li><code>1. elemento</code> per liste numerate</li>
                            </ul>
                        </div>
                    </details>
                    <textarea class="form-control" id="add-tip-text" rows="3" required placeholder="Inserisci un consiglio utile..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="addTip()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per modificare consiglio -->
    <div id="edit-tip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifica Consiglio</h3>
                <span class="close-modal" onclick="closeModal('edit-tip-modal')">&times;</span>
            </div>
            <form id="edit-tip-form">
                <input type="hidden" id="edit-tip-category">
                <input type="hidden" id="edit-tip-id">
                
                <div class="form-group">
                    <label class="form-label" for="edit-tip-text">Consiglio</label>
                    <details style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--primary);">Sintassi Markdown supportata</summary>
                        <div style="background-color: var(--light-gray); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                            <p><strong>Formattazione base:</strong></p>
                            <ul style="padding-left: 1.5rem;">
                                <li><code>**grassetto**</code> per <strong>grassetto</strong></li>
                                <li><code>*corsivo*</code> per <em>corsivo</em></li>
                                <li><code>[Link](https://example.com)</code> per <a href="#">link</a></li>
                                <li><code>- elemento</code> per liste puntate</li>
                                <li><code>1. elemento</code> per liste numerate</li>
                            </ul>
                        </div>
                    </details>
                    <textarea class="form-control" id="edit-tip-text" rows="3" required></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-error" onclick="deleteTip()">Elimina</button>
                    <button type="button" class="btn btn-primary" onclick="saveTip()">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per aggiungere contatto di emergenza -->
    <div id="add-emergency-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Aggiungi Contatto</h3>
                <span class="close-modal" onclick="closeModal('add-emergency-modal')">&times;</span>
            </div>
            <form id="add-emergency-form">
                <div class="form-group">
                    <label class="form-label" for="add-emergency-name">Nome</label>
                    <input type="text" class="form-control" id="add-emergency-name" required placeholder="es. Hotel, Emergenze, Ambasciata...">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="add-emergency-number">Numero</label>
                    <input type="text" class="form-control" id="add-emergency-number" required placeholder="es. +39 123 4567890">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="addEmergency()">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per modificare contatto di emergenza -->
    <div id="edit-emergency-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifica Contatto</h3>
                <span class="close-modal" onclick="closeModal('edit-emergency-modal')">&times;</span>
            </div>
            <form id="edit-emergency-form">
                <input type="hidden" id="edit-emergency-id">
                
                <div class="form-group">
                    <label class="form-label" for="edit-emergency-name">Nome</label>
                    <input type="text" class="form-control" id="edit-emergency-name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="edit-emergency-number">Numero</label>
                    <input type="text" class="form-control" id="edit-emergency-number" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-error" onclick="deleteEmergency()">Elimina</button>
                    <button type="button" class="btn btn-primary" onclick="saveEmergency()">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal per selezione tema -->
    <div id="theme-selector-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Seleziona Tema</h3>
                <span class="close-modal" onclick="closeModal('theme-selector-modal')">&times;</span>
            </div>
            <div class="theme-options">
                <div class="theme-option" onclick="changeTheme('default')">
                    <div class="theme-preview default-theme"></div>
                    <span>Tema Blu (Default)</span>
                </div>
                <div class="theme-option" onclick="changeTheme('green')">
                    <div class="theme-preview green-theme"></div>
                    <span>Tema Verde</span>
                </div>
                <div class="theme-option" onclick="changeTheme('purple')">
                    <div class="theme-preview purple-theme"></div>
                    <span>Tema Viola</span>
                </div>
                <div class="theme-option" onclick="changeTheme('gray')">
                    <div class="theme-preview gray-theme"></div>
                    <span>Tema Grigio</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Dati dei consigli con placeholder
        let tipsGeneralData = [
            "Esempio: Verifica i documenti necessari per il viaggio",
            "Esempio: Controlla le previsioni meteo prima della partenza",
            "Esempio: Porta con te medicinali di base"
        ];

        let tipsTransportData = [
            "Esempio: Verifica gli orari dei mezzi pubblici in anticipo",
            "Esempio: Considera l'acquisto di biglietti o pass per pi√π giorni",
            "Esempio: Scarica l'app per la mobilit√† locale"
        ];

        let tipsAttractionsData = [
            "Esempio: Prenota le attrazioni principali in anticipo",
            "Esempio: Verifica gli orari di apertura e chiusura",
            "Esempio: Cerca sconti o offerte per gruppi/famiglie"
        ];

        // Dati dell'itinerario (giorni e attivit√†)
        let itineraryData = [];
        
        // Dati dei numeri utili con placeholder
        let emergencyData = [
            {
                id: 1,
                name: "Emergenze",
                number: "112"
            },
            {
                id: 2,
                name: "Esempio: Hotel",
                number: "+00 123 456789"
            },
            {
                id: 3,
                name: "Esempio: Contatto locale",
                number: "+00 987 654321"
            }
        ];

        // Funzioni per la gestione del localStorage
        function saveToLocalStorage() {
            const mainTitle = document.getElementById('main-title').innerText;
            localStorage.setItem('mainTitle', mainTitle);
            localStorage.setItem('itineraryData', JSON.stringify(itineraryData));
            localStorage.setItem('tipsGeneralData', JSON.stringify(tipsGeneralData));
            localStorage.setItem('tipsTransportData', JSON.stringify(tipsTransportData));
            localStorage.setItem('tipsAttractionsData', JSON.stringify(tipsAttractionsData));
            localStorage.setItem('emergencyData', JSON.stringify(emergencyData));
            localStorage.setItem('notesVisible', notesVisible);
            localStorage.setItem('descriptionsVisible', descriptionsVisible);
            showNotification('Dati salvati');
        }
        
        function getSafeStorage() {
            try {
                return localStorage;
            } catch (e) {
                return {
                    getItem: () => null,
                    setItem: () => {},
                    removeItem: () => {}
                };
            }
        }

        // Variabili di stato
        let notesVisible = true;
        let descriptionsVisible = true;

        function toggleAllNotes() {
            notesVisible = !notesVisible;
            const daysContainer = document.getElementById('days-container');
            daysContainer.classList.toggle('hidden-notes', !notesVisible);
            saveToLocalStorage();
            showNotification(notesVisible ? 'Note mostrate' : 'Note nascoste');
        }

        function toggleAllDescriptions() {
            descriptionsVisible = !descriptionsVisible;
            const daysContainer = document.getElementById('days-container');
            daysContainer.classList.toggle('hidden-descriptions', !descriptionsVisible);
            saveToLocalStorage();
            showNotification(descriptionsVisible ? 'Descrizioni mostrate' : 'Descrizioni nascoste');
        }
        
        function loadFromLocalStorage() {
            const savedTitle = localStorage.getItem('mainTitle');
            const savedItinerary = localStorage.getItem('itineraryData');
            const savedTipsGeneral = localStorage.getItem('tipsGeneralData');
            const savedTipsTransport = localStorage.getItem('tipsTransportData');
            const savedTipsAttractions = localStorage.getItem('tipsAttractionsData');
            const savedEmergency = localStorage.getItem('emergencyData');
            
            if (savedTitle) {
                document.getElementById('main-title').innerText = savedTitle;
            }
            
            if (savedItinerary) {
                itineraryData = JSON.parse(savedItinerary);
            }
            
            if (savedTipsGeneral) {
                tipsGeneralData = JSON.parse(savedTipsGeneral);
            }
            
            if (savedTipsTransport) {
                tipsTransportData = JSON.parse(savedTipsTransport);
            }
            
            if (savedTipsAttractions) {
                tipsAttractionsData = JSON.parse(savedTipsAttractions);
            }
            
            if (savedEmergency) {
                emergencyData = JSON.parse(savedEmergency);
            }
            
            renderAll();
            showNotification('Dati caricati');

            notesVisible = localStorage.getItem('notesVisible') !== 'false';
            descriptionsVisible = localStorage.getItem('descriptionsVisible') !== 'false';
            
            const daysContainer = document.getElementById('days-container');
            daysContainer.classList.toggle('hidden-notes', !notesVisible);
            daysContainer.classList.toggle('hidden-descriptions', !descriptionsVisible);
        }
        
        window.loadArchivedTrip = function(tripName) {
            try {
                const archivedTrips = JSON.parse(localStorage.getItem('archivedTrips') || '{}');
                const tripData = archivedTrips[tripName];
                
                if (tripData) {
                    // Aggiorna i dati correnti
                    document.getElementById('main-title').innerText = tripData.mainTitle || 'Il Mio Viaggio';
                    itineraryData = tripData.itineraryData || [];
                    tipsGeneralData = tripData.tipsGeneralData || [];
                    tipsTransportData = tripData.tipsTransportData || [];
                    tipsAttractionsData = tripData.tipsAttractionsData || [];
                    emergencyData = tripData.emergencyData || [];
                    
                    saveToLocalStorage();
                    renderAll();
                    showNotification(`Viaggio "${tripName}" caricato!`);
                    return true;
                }
                showNotification('Viaggio non trovato!');
                return false;
            } catch (error) {
                console.error('Errore caricamento viaggio:', error);
                showNotification('Errore nel caricamento del viaggio');
                return false;
            }
        };
        
        // Funzioni per riordinare gli elementi
        // Abilita funzionalit√† di riordinamento per i giorni
        function enableDayReordering() {
            const daysContainer = document.getElementById('days-container');
            const dayElements = daysContainer.querySelectorAll('.day');
            
            // Aggiungi pulsanti di riordinamento a ogni giorno
            dayElements.forEach(day => {
                // Verifica se i pulsanti sono gi√† presenti
                if (!day.querySelector('.reorder-buttons')) {
                    const dayHeader = day.querySelector('.day-header');
                    
                    // Crea il contenitore dei pulsanti
                    const reorderButtons = document.createElement('div');
                    reorderButtons.className = 'reorder-buttons';
                    reorderButtons.style.display = 'flex';
                    reorderButtons.style.gap = '0.5rem';
                    
                    // Ottieni l'ID del giorno
                    const dayId = parseInt(day.id.replace('day-', ''));
                    
                    // Pulsante "Sposta su"
                    const upButton = document.createElement('button');
                    upButton.className = 'btn btn-secondary';
                    upButton.innerHTML = '‚Üë';
                    upButton.style.padding = '0.25rem 0.5rem';
                    upButton.title = 'Sposta su';
                    upButton.onclick = (e) => {
                        e.stopPropagation();
                        moveDayUp(dayId);
                    };
                    
                    // Pulsante "Sposta gi√π"
                    const downButton = document.createElement('button');
                    downButton.className = 'btn btn-secondary';
                    downButton.innerHTML = '‚Üì';
                    downButton.style.padding = '0.25rem 0.5rem';
                    downButton.title = 'Sposta gi√π';
                    downButton.onclick = (e) => {
                        e.stopPropagation();
                        moveDayDown(dayId);
                    };
                    
                    // Aggiungi i pulsanti al contenitore
                    reorderButtons.appendChild(upButton);
                    reorderButtons.appendChild(downButton);
                    
                    // Aggiungi il contenitore dei pulsanti all'header del giorno
                    dayHeader.appendChild(reorderButtons);
                }
            });
        }

        // Muovi un giorno verso l'alto nella lista
        function moveDayUp(dayId) {
            const dayIndex = itineraryData.findIndex(day => day.id === dayId);
            
            // Se il giorno √® gi√† in cima, non fare nulla
            if (dayIndex <= 0) return;
            
            // Scambia la posizione con il giorno sopra
            [itineraryData[dayIndex], itineraryData[dayIndex - 1]] = 
            [itineraryData[dayIndex - 1], itineraryData[dayIndex]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderDays();
            enableDayReordering(); // Riabilita i pulsanti di riordinamento
        }

        // Muovi un giorno verso il basso nella lista
        function moveDayDown(dayId) {
            const dayIndex = itineraryData.findIndex(day => day.id === dayId);
            
            // Se il giorno √® gi√† in fondo, non fare nulla
            if (dayIndex >= itineraryData.length - 1) return;
            
            // Scambia la posizione con il giorno sotto
            [itineraryData[dayIndex], itineraryData[dayIndex + 1]] = 
            [itineraryData[dayIndex + 1], itineraryData[dayIndex]];
            
            // Salva e aggiorna la UI
            saveToLocalStorage();
            renderDays();
            enableDayReordering(); // Riabilita i pulsanti di riordinamento
        }

        // Abilita funzionalit√† di riordinamento per le attivit√†
        function enableActivityReordering(dayId) {
            const dayElement = document.getElementById(`day-${dayId}`);
            if (!dayElement) return;
            
            const activityElements = dayElement.querySelectorAll('.activity');
            
            activityElements.forEach(activity => {
                if (!activity.querySelector('.activity-reorder-buttons')) {
                    const activityHeader = activity.querySelector('.activity-header');
                    
                    const reorderButtons = document.createElement('div');
                    reorderButtons.className = 'activity-reorder-buttons';
                    reorderButtons.style.display = 'flex';
                    reorderButtons.style.gap = '0.5rem';
                    reorderButtons.style.flexWrap = 'wrap';
                    
                    const activityId = parseInt(activity.querySelector('.edit-activity button').getAttribute('onclick').match(/\d+\s*,\s*(\d+)/)[1]);
                    
                    // Pulsante Sposta su
                    const upButton = document.createElement('button');
                    upButton.className = 'btn btn-secondary';
                    upButton.innerHTML = '‚Üë';
                    upButton.style.padding = '0.25rem 0.5rem';
                    upButton.style.fontSize = '0.8rem';
                    upButton.title = 'Sposta su';
                    upButton.onclick = (e) => {
                        e.stopPropagation();
                        moveActivityUp(dayId, activityId);
                    };
                    
                    // Pulsante Sposta gi√π
                    const downButton = document.createElement('button');
                    downButton.className = 'btn btn-secondary';
                    downButton.innerHTML = '‚Üì';
                    downButton.style.padding = '0.25rem 0.5rem';
                    downButton.style.fontSize = '0.8rem';
                    downButton.title = 'Sposta gi√π';
                    downButton.onclick = (e) => {
                        e.stopPropagation();
                        moveActivityDown(dayId, activityId);
                    };
                    
                    // Menu a tendina per spostare tra giorni
                    if (itineraryData.length > 1) {
                        const moveSelect = document.createElement('select');
                        moveSelect.className = 'form-control';
                        moveSelect.style.width = 'auto';
                        moveSelect.style.margin = '0 0.5rem';
                        moveSelect.innerHTML = '<option value="">Sposta in...</option>';
                        
                        itineraryData.forEach(d => {
                            if (d.id !== dayId) {
                                moveSelect.innerHTML += `<option value="${d.id}">${d.title}</option>`;
                            }
                        });
                        
                        moveSelect.onchange = (e) => {
                            if (e.target.value) {
                                moveActivityToDay(dayId, activityId, parseInt(e.target.value));
                                e.target.value = '';
                            }
                        };
                        
                        reorderButtons.appendChild(moveSelect);
                    }
                    
                    reorderButtons.appendChild(upButton);
                    reorderButtons.appendChild(downButton);
                    
                    activityHeader.appendChild(reorderButtons);
                }
            });
        }